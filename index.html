<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>The Run Club MVP</title>
  <!-- Mapbox GL JS -->
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.css" rel="stylesheet" />
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.js"></script>
  <!-- React & Tailwind -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body, html { height: 100%; margin: 0; padding: 0; }
    #root { height: 100vh; }
    .run-marker {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      position: absolute;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      transition: transform 0.2s;
      z-index: 2;
      font-size: 1.25rem;
      background: #0066cc;
      color: #fff;
      border: 2px solid #fff;
    }
    .run-marker:hover { transform: scale(1.18);}
    .modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 99;}
    .modal { background: #fff; border-radius: 0.75rem; max-width: 450px; width: 95%; max-height: 92vh; overflow-y: auto; padding: 2rem 1.5rem 1.5rem 1.5rem; position: relative;}
    .close-btn { position: absolute; top: 0.6rem; right: 1rem; cursor: pointer; font-size: 1.7rem; color: #333;}
    #map { width: 100%; height: 100%; min-height: 600px; border-radius: 0; }
    .filter-chip {
      @apply px-3 py-1 rounded-full bg-gray-100 text-gray-700 cursor-pointer border border-gray-200 hover:bg-blue-100 hover:text-blue-700 transition;
      margin-right: 0.5rem;
      margin-bottom: 0.3rem;
      display: inline-block;
      font-size: 0.95rem;
    }
    .filter-chip.selected {
      background: #2563eb !important;
      color: #fff !important;
      border-color: #2563eb !important;
    }
    .filter-toggle {
      @apply px-3 py-1 rounded bg-gray-100 border border-gray-300 cursor-pointer hover:bg-blue-100 transition text-sm;
      margin-right: 0.7rem;
    }
    .filter-toggle.selected {
      background: #2563eb !important;
      color: #fff !important;
      border-color: #2563eb !important;
    }
  </style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
(() => {
  const { useState, useContext, createContext } = React;

  // ---- Mapbox token (yours) ----
  const MAPBOX_TOKEN = "pk.eyJ1IjoiYWxiYXJ0c3M5NCIsImEiOiJjbWM2NjNtejMwczFxMmlzYXVra3d3Z3FnIn0.DEgmqut6d9l4IOO_oGjVjg";

  // ---- User "GPS" location (Liverpool Street London) ----
  const USER_GPS = { lat: 51.5175, lng: -0.0824 };

  // ---- Social tags for demo ----
  const SOCIAL_TAGS = ["Chatty", "Workout", "Long slow", "PB effort", "Meet new people"];

  // ---- Generate 50+ demo runs scattered across London ----
  function randomInRange(min, max) {
    return Math.random() * (max - min) + min;
  }
  function randomPick(arr) {
    return arr[Math.floor(Math.random() * arr.length)];
  }
  const avatarUrls = [
    "https://randomuser.me/api/portraits/women/8.jpg",
    "https://randomuser.me/api/portraits/men/22.jpg",
    "https://randomuser.me/api/portraits/women/15.jpg"
  ];
  const runNames = ["Sarah Chen", "Marcus Johnson", "Priya Patel"];
  const runTitles = ["Chatty 5K", "Marathon Training Social", "Evening 8K", "Lunch Loop", "Morning Social", "Regents Park 10K", "River Thames Run", "Hyde Park Loops", "Clapham Speedwork", "Hackney Tempo"];
  const runDescs = [
    "Social 5K around Hyde Park.",
    "10K social run prep.",
    "Relaxed city run.",
    "Easy loop at lunch.",
    "Early morning easy pace.",
    "Speed session in the park.",
    "Sunset run by the river.",
    "Hill sprints and good chat.",
    "Community tempo effort.",
    "Easy recovery jog."
  ];
  // Spread runs across key areas
  const clusters = [
    {name:"Hackney",lat:51.5465,lng:-0.0552,count:16},
    {name:"Clapham",lat:51.4637,lng:-0.1384,count:11},
    {name:"Hyde Park",lat:51.5073,lng:-0.1657,count:9},
    {name:"Regents Park",lat:51.5313,lng:-0.1569,count:7},
    {name:"Thames Riverside",lat:51.505,lng:-0.09,count:10}
  ];
  let runs = [];
  let idx = 0;
  clusters.forEach(clu => {
    for(let i=0;i<clu.count;i++) {
      const lat = clu.lat + randomInRange(-0.009,0.009);
      const lng = clu.lng + randomInRange(-0.012,0.012);
      const paceSecPerKm = 180 + Math.floor(randomInRange(0, 300)); // 3:00/km to 8:00/km
      const distanceKm = Math.round(randomInRange(1, 50));
      const wingIt = Math.random() > 0.7;
      const startTime = Date.now() + randomInRange(3600e3, 14*3600e3); // Now+1h to Now+14h
      const social_tag = [randomPick(SOCIAL_TAGS)];
      if(Math.random() > 0.7) social_tag.push(randomPick(SOCIAL_TAGS.filter(t=>!social_tag.includes(t))));
      runs.push({
        id: (++idx).toString(),
        title: runTitles[idx%runTitles.length],
        description: runDescs[idx%runDescs.length],
        userName: runNames[idx%runNames.length],
        userAvatar: avatarUrls[idx%avatarUrls.length],
        paceSecPerKm,
        distanceKm,
        status: "planned",
        meetingPoint: { lat, lng },
        wingIt,
        startTime,
        social_tag
      });
    }
  });

  // ---- Context & Auth ----
  const AuthContext = createContext(null);
  const useAuth = () => {
    const ctx = useContext(AuthContext);
    if (!ctx) throw new Error('useAuth must be inside AuthProvider');
    return ctx;
  };
  const AuthProvider = ({ children }) => {
    const [user, setUser] = useState(null);
    const login = () => setUser({ id: '1', name: 'Alex Runner', avatar: 'https://ui-avatars.com/api/?name=Alex+Runner&background=0066CC&color=fff' });
    const logout = () => setUser(null);
    return <AuthContext.Provider value={{ user, login, logout }}>{children}</AuthContext.Provider>;
  };

  // ---- Formatters ----
  const formatPace = spk => {
    const m = Math.floor(spk / 60), s = spk % 60;
    return `${m}:${s.toString().padStart(2, '0')}/km`;
  };
  function haversine(lat1, lng1, lat2, lng2) {
    const toRad = x => x * Math.PI / 180;
    const R = 6371;
    const dLat = toRad(lat2 - lat1), dLng = toRad(lng2 - lng1);
    const a = Math.sin(dLat/2)*Math.sin(dLat/2) + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLng/2)*Math.sin(dLng/2);
    return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  }

  // ---- Filter logic ----
  function filterRuns(all, filt) {
    return all.filter(run => {
      if(run.paceSecPerKm < filt.pace[0]*60 || run.paceSecPerKm > filt.pace[1]*60) return false;
      if(run.distanceKm < filt.distance[0] || run.distanceKm > filt.distance[1]) return false;
      if(filt.runStyle !== "all" && (filt.runStyle === "planned" && run.wingIt) || (filt.runStyle === "wing" && !run.wingIt)) return false;
      if(filt.tags.length > 0 && !filt.tags.some(tag => (run.social_tag||[]).includes(tag))) return false;
      // Only runs starting after now
      if(run.startTime < Date.now()) return false;
      return true;
    });
  }

  // ---- Components ----
  function SafetyGate({ onAccept }) {
    return (
      <div className="modal-backdrop">
        <div className="modal">
          <h2 className="text-2xl mb-4">Safety First</h2>
          <ul className="list-disc pl-5 mb-6">
            <li>You are 16 or older</li>
            <li>Meet in public places only</li>
            <li>Run at your own risk</li>
          </ul>
          <button onClick={onAccept} className="px-4 py-2 bg-blue-600 text-white rounded">I Understand</button>
        </div>
      </div>
    );
  }

  function LoginScreen() {
    const { login } = useAuth();
    return (
      <div className="min-h-screen flex items-center justify-center bg-gray-50">
        <div className="bg-white p-8 rounded-lg shadow-lg text-center">
          <h1 className="text-3xl mb-4">The Run Club</h1>
          <button onClick={login} className="flex items-center gap-2 bg-blue-600 text-white px-4 py-3 rounded">
            <svg className="w-5 h-5" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" fill="white"/><path fill="currentColor" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92z"/></svg>
            Continue with Google
          </button>
        </div>
      </div>
    );
  }

  function InstagramGallery() {
    const pics = [
      "https://images.pexels.com/photos/726484/pexels-photo-726484.jpeg",
      "https://images.pexels.com/photos/9828319/pexels-photo-9828319.jpeg",
      "https://images.pexels.com/photos/15509934/pexels-photo-15509934.jpeg"
    ];
    return (
      <div className="mt-4">
        <h3 className="font-semibold mb-2">Photos</h3>
        <div className="grid grid-cols-3 gap-2">
          {pics.map((src, i) => (
            <img key={i} src={src} className="w-full h-24 object-cover rounded" alt="" />
          ))}
        </div>
      </div>
    );
  }

  function ChatPanel() {
    const [msgs] = useState([{id:1,user:'Sarah',text:'Excited?',time:'10:15'},{id:2,user:'You',text:'Yep!',time:'10:17'}]);
    const [input, setInput] = useState('');
    return <div className="flex flex-col h-52 border rounded-lg overflow-hidden"><div className="flex-1 p-3 overflow-y-auto space-y-2">{msgs.map(m=><div key={m.id} className={m.user==='You'?'flex justify-end':'flex'}><div className={`px-3 py-2 rounded ${m.user==='You'?'bg-blue-600 text-white':'bg-gray-200 text-black'}`}><p>{m.text}</p><span className="text-xs text-gray-500">{m.time}</span></div></div>)}</div><div className="border-t p-2 flex"><input className="flex-1 border px-3 py-2 rounded-l" value={input} onChange={e=>setInput(e.target.value)} placeholder="Type…" /><button className="px-4 bg-blue-600 text-white rounded-r">Send</button></div></div>;
  }

  function RunDetailModal({ run, onClose }) {
    const { lat, lng } = run.meetingPoint;
    const mapUrl = `https://api.mapbox.com/styles/v1/mapbox/streets-v11/static/pin-s+0066cc(${lng},${lat})/${lng},${lat},13/400x200?access_token=${MAPBOX_TOKEN}`;
    return (
      <div className="modal-backdrop">
        <div className="modal">
          <div className="close-btn" onClick={onClose}>×</div>
          <h2 className="text-xl font-bold mb-2">{run.title}</h2>
          <p className="mb-2 text-gray-700">{run.description}</p>
          <img src={mapUrl} className="w-full h-32 object-cover rounded mb-4" alt="Route" />
          <InstagramGallery />
          <div className="mt-4"><h3 className="font-semibold mb-2">Chat</h3><ChatPanel /></div>
        </div>
      </div>
    );
  }

  function FiltersBar({ value, setValue }) {
    // Controlled range sliders and toggles for pace/distance/runstyle/tags
    return (
      <div className="mb-4 p-3 bg-gray-50 rounded-lg border border-gray-200 flex flex-col gap-2">
        <div className="flex items-center gap-4">
          <span className="font-medium text-sm mr-1">Pace</span>
          <input type="range" min="3" max="8" step="0.1" value={value.pace[0]} onChange={e=>setValue(v=>({...v,pace:[+e.target.value, v.pace[1]]}))} className="w-24" />
          <span className="text-xs w-10 text-right">{value.pace[0].toFixed(1)}</span>
          <span>-</span>
          <input type="range" min="3" max="8" step="0.1" value={value.pace[1]} onChange={e=>setValue(v=>({...v,pace:[v.pace[0], +e.target.value]}))} className="w-24" />
          <span className="text-xs w-10">{value.pace[1].toFixed(1)} min/km</span>
        </div>
        <div className="flex items-center gap-4">
          <span className="font-medium text-sm mr-1">Distance</span>
          <input type="range" min="1" max="50" value={value.distance[0]} onChange={e=>setValue(v=>({...v,distance:[+e.target.value, v.distance[1]]}))} className="w-16" />
          <span className="text-xs w-8 text-right">{value.distance[0]}</span>
          <span>-</span>
          <input type="range" min="1" max="50" value={value.distance[1]} onChange={e=>setValue(v=>({...v,distance:[v.distance[0], +e.target.value]}))} className="w-16" />
          <span className="text-xs w-8">{value.distance[1]} km</span>
        </div>
        <div className="flex items-center gap-2">
          <span className="font-medium text-sm">Run style</span>
          <button className={"filter-toggle" + (value.runStyle==="all"?" selected":"")} onClick={()=>setValue(v=>({...v,runStyle:"all"}))}>All</button>
          <button className={"filter-toggle" + (value.runStyle==="planned"?" selected":"")} onClick={()=>setValue(v=>({...v,runStyle:"planned"}))}>Planned route</button>
          <button className={"filter-toggle" + (value.runStyle==="wing"?" selected":"")} onClick={()=>setValue(v=>({...v,runStyle:"wing"}))}>Wing it</button>
        </div>
        <div className="flex items-center gap-2 flex-wrap">
          <span className="font-medium text-sm">Tags</span>
          {SOCIAL_TAGS.map(tag =>
            <span key={tag} className={"filter-chip" + (value.tags.includes(tag) ? " selected" : "")}
              onClick={()=>{
                setValue(v=>{
                  const tags = v.tags.includes(tag) ? v.tags.filter(t=>t!==tag) : [...v.tags, tag];
                  return {...v, tags};
                });
              }}>{tag}</span>
          )}
        </div>
      </div>
    );
  }

  function MainApp() {
    const { user, logout } = useAuth();
    const [selected, setSelected] = useState(null);
    const [filter, setFilter] = useState({
      pace: [3,8],
      distance: [1,50],
      runStyle: "all", // all/planned/wing
      tags: []
    });
    // Expose setSelected globally so map clicks can trigger React modal
    window.openRunModalById = rid => {
      const found = runs.find(r=>r.id===rid);
      if(found) setSelected(found);
    };
    // Filtered runs
    const filteredRuns = filterRuns(runs, filter);

    // Map logic
    React.useEffect(() => {
      mapboxgl.accessToken = MAPBOX_TOKEN;
      const map = new mapboxgl.Map({
        container: "map",
        style: "mapbox://styles/mapbox/streets-v11",
        center: [-0.1278, 51.5074],
        zoom: 11,
        minZoom: 9,
        maxZoom: 16,
        dragRotate: false, // Prevent rotation
        touchPitch: false
      });
      map.addControl(new mapboxgl.NavigationControl({showCompass:true}), 'top-right');

      // Add user "GPS" marker
      const userMarker = new mapboxgl.Marker({color:'#22d3ee'})
        .setLngLat([USER_GPS.lng, USER_GPS.lat])
        .setPopup(new mapboxgl.Popup().setHTML('<b>Your location (Liverpool St)</b>'))
        .addTo(map);

      // Turn filteredRuns into geojson
      const geoRuns = {
        type: "FeatureCollection",
        features: filteredRuns.map(r => ({
          type: "Feature",
          properties: {
            id: r.id,
            title: r.title,
            description: r.description,
            userName: r.userName,
            userAvatar: r.userAvatar
          },
          geometry: {
            type: "Point",
            coordinates: [r.meetingPoint.lng, r.meetingPoint.lat]
          }
        }))
      };
      map.on("load", function () {
        if(map.getSource("runs")) map.removeSource("runs");
        map.addSource("runs", {
          type: "geojson",
          data: geoRuns,
          cluster: true,
          clusterMaxZoom: 13,
          clusterRadius: 48
        });

        map.addLayer({
          id: "clusters",
          type: "circle",
          source: "runs",
          filter: ["has", "point_count"],
          paint: {
            "circle-color": "#0066cc",
            "circle-radius": [
              "step", ["get", "point_count"], 20, 10, 25, 50, 35
            ],
            "circle-opacity": 0.7
          }
        });

        map.addLayer({
          id: "cluster-count",
          type: "symbol",
          source: "runs",
          filter: ["has", "point_count"],
          layout: {
            "text-field": "{point_count_abbreviated}",
            "text-font": ["DIN Offc Pro Medium", "Arial Unicode MS Bold"],
            "text-size": 15
          }
        });

        map.addLayer({
          id: "unclustered-point",
          type: "circle",
          source: "runs",
          filter: ["!", ["has", "point_count"]],
          paint: {
            "circle-color": "#ff4d4d",
            "circle-radius": 9,
            "circle-stroke-width": 2,
            "circle-stroke-color": "#fff"
          }
        });

        // Cluster zoom in
        map.on('click', 'clusters', function (e) {
          const features = map.queryRenderedFeatures(e.point, { layers: ['clusters'] });
          const clusterId = features[0].properties.cluster_id;
          map.getSource('runs').getClusterExpansionZoom(clusterId, function (err, zoom) {
            if (err) return;
            map.easeTo({ center: features[0].geometry.coordinates, zoom: zoom });
          });
        });

        // Run popup AND open React modal!
        map.on('click', 'unclustered-point', function (e) {
          const props = e.features[0].properties;
          window.openRunModalById(props.id);
        });

        // Change cursor
        map.on('mouseenter', 'clusters', () => map.getCanvas().style.cursor = 'pointer');
        map.on('mouseleave', 'clusters', () => map.getCanvas().style.cursor = '');
      });
      // Remove map on unmount
      return () => {
        map.remove();
      };
    }, [JSON.stringify(filteredRuns)]);

    return (
      <div className="h-screen flex flex-col bg-gray-50">
        <header className="bg-white shadow-sm p-4 flex justify-between items-center">
          <div className="flex items-center gap-3 select-none">
            <span style={{
              fontFamily: "'Inter', 'Roboto', 'Montserrat', Arial, sans-serif",
              fontWeight: 600,
              letterSpacing: '.05em',
              fontSize: '1.65rem',
              color: '#111'
            }}>
              the run club
            </span>
            <svg width="36" height="36" viewBox="0 0 44 44" fill="none" xmlns="http://www.w3.org/2000/svg">
              <circle cx="22" cy="22" r="20" stroke="#0066cc" strokeWidth="2"/>
              <path d="M32 22c0 5.523-4.477 10-10 10s-10-4.477-10-10 4.477-10 10-10"
                    stroke="#0066cc" strokeWidth="2" fill="none" strokeLinecap="round"/>
              <circle cx="30" cy="16" r="2.2" fill="#0066cc"/>
              <path d="M29.8 17.5c-2 1.5-3.3 3.7-3.8 5.8" stroke="#0066cc" strokeWidth="2" strokeLinecap="round"/>
            </svg>
          </div>
          <div className="flex items-center gap-4">
            <img src={user.avatar} alt={user.name} className="w-8 h-8 rounded-full" />
            <button onClick={logout} className="text-sm text-gray-600">Sign out</button>
          </div>
        </header>
        <div className="flex flex-1 overflow-hidden">
          {/* Dynamic Mapbox map */}
          <div className="flex-1 relative min-w-0">
            <div id="map" style={{width:'100%',height:'100%',minHeight:'600px'}}></div>
          </div>
          {/* Sidebar */}
          <aside className="w-96 bg-white border-l p-4 overflow-y-auto">
            <FiltersBar value={filter} setValue={setFilter} />
            <h2 className="text-lg font-semibold mb-4">Upcoming Runs</h2>
            <div className="space-y-3">
              {filteredRuns.length === 0 && (
                <div className="text-gray-500 text-center py-12">No runs match your filters.</div>
              )}
              {filteredRuns.map(r => {
                const distance = haversine(USER_GPS.lat, USER_GPS.lng, r.meetingPoint.lat, r.meetingPoint.lng);
                return (
                <div key={r.id} className="bg-white p-4 rounded-lg shadow hover:shadow-md relative">
                  <div className="flex items-center gap-3 mb-2">
                    <img src={r.userAvatar} alt={r.userName} className="w-9 h-9 rounded-full" />
                    <div>
                      <p className="font-semibold">{r.title}</p>
                      <p className="text-sm text-gray-600">{r.userName}</p>
                    </div>
                    <span className="ml-auto font-semibold text-blue-700 text-xs px-2 py-1 bg-blue-50 rounded">
                      {distance.toFixed(1)} km
                    </span>
                  </div>
                  <p className="text-sm text-gray-600">{formatPace(r.paceSecPerKm)} • {r.distanceKm}km</p>
                  <p className="text-xs text-gray-500 mt-1">{r.description}</p>
                  <div className="flex flex-wrap gap-1 mt-2">
                    {r.social_tag && r.social_tag.map(tag =>
                      <span key={tag} className="px-2 py-1 bg-blue-100 text-blue-700 rounded-full text-xs">{tag}</span>
                    )}
                    {r.wingIt && <span className="px-2 py-1 bg-orange-100 text-orange-700 rounded-full text-xs">Wing it</span>}
                  </div>
                  <button onClick={() => setSelected(r)} className="mt-2 text-blue-600 hover:underline text-sm">View Details</button>
                </div>
              )})}
            </div>
          </aside>
        </div>
        {selected && <RunDetailModal run={selected} onClose={() => setSelected(null)} />}
      </div>
    );
  }

  function App() {
    const [accepted, setAccepted] = useState(false);
    const { user } = useAuth();
    if (!accepted) return <SafetyGate onAccept={() => setAccepted(true)} />;
    if (!user) return <LoginScreen />;
    return <MainApp />;
  }

  ReactDOM.render(<AuthProvider><App /></AuthProvider>, document.getElementById('root'));
})();
</script>
</body>
</html>
